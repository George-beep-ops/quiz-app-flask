{% extends "base.html" %}

{% block title %}Minispiel 2 – Gefahr erkennen{% endblock %}

{% block extra_style %}
<style>
  canvas {
    background: white;
    border: 2px solid #ccc;
    margin-top: 1rem;
    max-width: 90vw;
    height: 300px;
  }
</style>
{% endblock %}

{% block content %}
  <h2>Was ist eine mögliche Gefahr bei Gamification? Wähle bitte drei passende Begriffe!</h2>
  <canvas id="gameCanvas" width="800" height="300"></canvas>
  <form method="POST" id="submitForm">
    <input type="hidden" name="score" id="scoreInput" value="0">
  </form>
{% endblock %}

{% block script %}
<script>
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  const targets = [
    "zu wenige spiele", "zu viele spiele", "ablenkung",
    "einsamkeit", "traurigkeit", "bedauern"
  ];
  const correctTargets = [
    "zu wenige spiele", "einsamkeit", "traurigkeit", "bedauern"
  ];

  let floating = [];
  let score = 0;
  let hits = 0;
  let gameRunning = true;

  class Word {
    constructor(text) {
      this.text = text;
      this.x = Math.random() * (canvas.width - 100);
      this.y = Math.random() * canvas.height;
      this.speed = 0.5 + Math.random();
      this.hit = false;
    }

    update() {
      if (!this.hit) {
        this.y += this.speed;
        if (this.y > canvas.height) this.y = 0;
      }
    }

    draw() {
      ctx.fillStyle = this.hit ? "#ccc" : "#333";
      ctx.font = "bold 20px Arial";
      ctx.fillText(this.text, this.x, this.y);
    }

    isClicked(x, y) {
      const width = ctx.measureText(this.text).width;
      return (
        x >= this.x && x <= this.x + width &&
        y >= this.y - 20 && y <= this.y
      );
    }
  }

  function setup() {
    targets.forEach(t => floating.push(new Word(t)));
  }

  function gameLoop() {
    if (!gameRunning) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    floating.forEach(w => {
      w.update();
      w.draw();
    });
    requestAnimationFrame(gameLoop);
  }

  canvas.addEventListener("click", function(e) {
    if (!gameRunning) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    floating.forEach(w => {
      if (!w.hit && w.isClicked(x, y)) {
        w.hit = true;
        if (correctTargets.includes(w.text)) {
          score++;
          hits++;
        }
      }
    });

    if (hits >= 3) {
      endGame();
    }
  });

  function endGame() {
    gameRunning = false;
    document.getElementById("scoreInput").value = score;
    document.getElementById("submitForm").submit();
  }

  setup();
  gameLoop();

  setTimeout(() => {
    if (gameRunning) {
      endGame();
    }
  }, 10000);
</script>
{% endblock %}
