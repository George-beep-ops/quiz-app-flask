{% extends 'base.html' %}

{% block title %}Ergebnisse{% endblock %}

{% block content %}
  <h2>Danke f√ºrs Mitmachen!</h2>
  <canvas id="rocketCanvas" width="400" height="400" style="margin-top: 2rem;"></canvas>
  <div id="scoreDisplay" data-score="{{ session['score'] | default(0) }}" style="font-size: 1.6rem; font-weight: bold; display: none; margin-top: 1rem;"></div>
{% endblock %}

{% block script %}
<script>
const canvas = document.getElementById("rocketCanvas");
const ctx = canvas.getContext("2d");
let flameTouch = null;
let ignitionStart = null;
let fuseLit = false;
let explosionStarted = false;
let explosionFinished = false;
let spinAngle = 0;
let spinSpeed = 0;
let particles = [];

const scoreDisplay = document.getElementById("scoreDisplay");
const score = Number(scoreDisplay.dataset.score);

canvas.addEventListener("touchstart", e => {
  flameTouch = e.touches[0];
  ignitionStart = Date.now();
});

canvas.addEventListener("touchmove", e => {
  flameTouch = e.touches[0];
});

canvas.addEventListener("touchend", () => {
  flameTouch = null;
  ignitionStart = null;
});

function drawFlame(x, y) {
  ctx.save();
  ctx.translate(x, y);
  ctx.fillStyle = "orange";
  ctx.beginPath();
  ctx.ellipse(0, 0, 6, 10, 0, 0, 2 * Math.PI);
  ctx.fill();
  ctx.restore();
}

function drawFuse(length) {
  ctx.strokeStyle = "#444";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(200, 200);
  ctx.lineTo(200, 200 - length);
  ctx.stroke();
}

function drawBody() {
  ctx.save();
  ctx.translate(200, 200);
  ctx.rotate(spinAngle);
  ctx.fillStyle = "#ffaa00";
  ctx.beginPath();
  ctx.arc(0, 0, 30, 0, 2 * Math.PI);
  ctx.fill();
  if (fuseLit && !explosionStarted) {
    // Flammen links und rechts
    ctx.fillStyle = "red";
    ctx.beginPath();
    ctx.arc(-40, 0, 10, 0, 2 * Math.PI);
    ctx.arc(40, 0, 10, 0, 2 * Math.PI);
    ctx.fill();
  }
  ctx.restore();
}

function createExplosion() {
  for (let i = 0; i < 150; i++) {
    const angle = Math.random() * 2 * Math.PI;
    const speed = Math.random() * 5 + 2;
    particles.push({
      x: 200,
      y: 200,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed,
      alpha: 1,
      color: `hsl(${Math.random() * 360}, 100%, 60%)`
    });
  }
}

function drawExplosion() {
  particles.forEach(p => {
    ctx.fillStyle = `rgba(${p.color}, ${p.alpha})`;
    ctx.beginPath();
    ctx.arc(p.x, p.y, 3, 0, 2 * Math.PI);
    ctx.fill();
    p.x += p.vx;
    p.y += p.vy;
    p.alpha -= 0.02;
  });
  particles = particles.filter(p => p.alpha > 0);
  if (particles.length === 0 && !explosionFinished) {
    explosionFinished = true;
    scoreDisplay.textContent = `Du hast ${score} Punkte erreicht! üëç`;
    scoreDisplay.style.display = "block";
  }
}

function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (!fuseLit && flameTouch) {
    const flameX = flameTouch.clientX - canvas.getBoundingClientRect().left;
    const flameY = flameTouch.clientY - canvas.getBoundingClientRect().top;
    drawFlame(flameX, flameY);
    const distToFuse = Math.hypot(flameX - 200, flameY - 180);
    if (distToFuse < 20 && ignitionStart && Date.now() - ignitionStart > 2000) {
      fuseLit = true;
    }
  }

  if (!fuseLit) {
    drawFuse(20);
    drawBody();
  } else if (!explosionStarted) {
    drawBody();
    spinSpeed += 0.01;
    spinAngle += spinSpeed;
    if (spinSpeed > 0.6) {
      explosionStarted = true;
      createExplosion();
    }
  } else {
    drawExplosion();
  }

  requestAnimationFrame(animate);
}

animate();
</script>
{% endblock %}


