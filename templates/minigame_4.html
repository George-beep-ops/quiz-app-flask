{% extends 'base.html' %}

{% block title %}Minispiel 4 – Begriffe und Bewegung{% endblock %}

{% block content %}
  <h2>Minispiel 4 - Vergesse nicht!</strong> <br> Gebe die zwei Begriffe unseres Themas ein (getrennt mit Komma) und lege das Handy <strong>innerhalb von 20 Sekunden waagerecht</strong> auf den Tisch.</h2>

  <input type="text" id="inputField" placeholder="Begriffe eingeben..." style="padding: 1rem; font-size: 1rem; width: 80%; max-width: 400px; margin-bottom: 1rem;">
  <div id="status" style="font-weight: bold; margin: 1rem; font-size: 1.2rem;">⏳ Zeit läuft: <span id="timer">20</span>s</div>
  <div id="extra" style="font-weight: bold; font-size: 1.2rem; color: green;"></div>

  <form method="POST" id="submitForm" style="display: none;">
    <input type="hidden" name="score" id="scoreInput" value="0">
  </form>
{% endblock %}

{% block script %}
<script>
  const correctAnswers = ["learning", "gamification"];
  let score = 0;
  let submitted = false;
  let flatDetected = false;
  let timer = 20;
  let allowFlatCheck = false;
  let lastTypingTime = 0;

  const inputField = document.getElementById("inputField");
  const timerDisplay = document.getElementById("timer");
  const extraDisplay = document.getElementById("extra");

  const countdown = setInterval(() => {
    timer--;
    timerDisplay.textContent = timer;

    if (timer <= 0 && !submitted) {
      clearInterval(countdown);
      checkInput();  // Punkte vergeben
      submitGame();
    }
  }, 1000);

  function checkInput() {
    const input = inputField.value.toLowerCase();
    const given = input.split(",").map(w => w.trim()).filter(w => w !== "");
    score = 0;
    correctAnswers.forEach(answer => {
      if (given.includes(answer)) {
        score++;
      }
    });
    return given.length >= 2;
  }

  function checkIfFlat(event) {
    if (!allowFlatCheck || submitted) return;

    const acc = event.accelerationIncludingGravity;
    const x = acc.x;
    const y = acc.y;
    const z = acc.z;

    // Nur wenn waagerecht (fast ausschließlich Z-Kraft)
    const isFlat = Math.abs(x) < 1 && Math.abs(y) < 1 && Math.abs(z) > 9.5;

    if (isFlat) {
      const hasTwoInputs = checkInput();
      if (hasTwoInputs) {
        flatDetected = true;
        score += 1; // Zusatzpunkt
        extraDisplay.textContent = "✅ Zusatzpunkt!";
        clearInterval(countdown);
        submitGame();
      }
    }
  }

  function submitGame() {
    submitted = true;
    document.getElementById("scoreInput").value = score;
    document.getElementById("submitForm").submit();
  }

  inputField.addEventListener("input", () => {
    lastTypingTime = new Date().getTime();
  });

  setInterval(() => {
    const input = inputField.value;
    const parts = input.split(",").map(w => w.trim());
    const now = new Date().getTime();

    if (parts.length >= 2 && parts[1].length > 0 && (now - lastTypingTime) > 2000) {
      allowFlatCheck = true;
    }
  }, 200);

  if (window.DeviceMotionEvent) {
    window.addEventListener("devicemotion", checkIfFlat);
  }
</script>
{% endblock %}


