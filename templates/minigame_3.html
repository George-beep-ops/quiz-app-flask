{% extends 'base.html' %}

{% block title %}Minispiel 3 – Reaktion per Bewegung{% endblock %}

{% block content %}
  <h2>Schüttle das Handy, wenn das Wort <span style="color: green;">"richtig"</span> erscheint!</h2>

  <div id="permissionOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; justify-content: center; align-items: center; z-index: 1000;">
    <button id="startButton" style="font-size: 1.5rem; padding: 1rem 2rem; background-color: #0077cc; color: white; border: none; border-radius: 8px;">Spiel starten</button>
  </div>

  <div id="wordBox"
       style="font-size: 2rem; font-weight: bold; padding: 2rem; background-color: white;
              border: 2px solid #333; border-radius: 12px; display: inline-block; min-width: 200px;">
    Bereit?
  </div>

  <form method="POST" id="submitForm" style="display: none;">
    <input type="hidden" name="score" id="scoreInput" value="0">
  </form>

  <div id="info" style="margin-top: 1rem; font-size: 1.2rem;"></div>
{% endblock %}

{% block script %}
<script>
  const words = ["falsch", "richtig", "nein", "richtig", "ja aber nein", "falsch"];
  const wordBox = document.getElementById("wordBox");
  const info = document.getElementById("info");
  const scoreInput = document.getElementById("scoreInput");
  const form = document.getElementById("submitForm");

  let score = 0;
  let shakeCount = 0;
  let lastShake = 0;
  let currentWord = "";
  let index = 0;
  let gameStarted = false;

  function showNextWord() {
    if (shakeCount >= 2) return;

    currentWord = words[index];
    wordBox.textContent = currentWord;
    info.textContent = "";
    index = (index + 1) % words.length;

    setTimeout(showNextWord, 2000);
  }

  function detectShake(event) {
    const now = new Date().getTime();
    if ((now - lastShake) < 1000) return;

    const acc = event.accelerationIncludingGravity;
    const total = Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z);

    if (total > 25 && shakeCount < 2) {
      lastShake = now;
      if (currentWord === "richtig") {
        score++;
        info.innerHTML = '<span style="color: green;">✔️ Punkt erhalten!</span>';
      } else {
        info.innerHTML = '<span style="color: red;">❌ Kein Punkt.</span>';
      }

      shakeCount++;

      if (shakeCount === 2) {
        setTimeout(() => {
          scoreInput.value = score;
          form.submit();
        }, 1500);
      }
    }
  }

  function enableMotionDetection() {
    if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
      DeviceMotionEvent.requestPermission()
        .then(permissionState => {
          if (permissionState === "granted") {
            window.addEventListener("devicemotion", detectShake, false);
            startGame();
          } else {
            alert("Bewegungserkennung wurde abgelehnt.");
          }
        }).catch(console.error);
    } else {
      // Für Android oder alte Browser
      window.addEventListener("devicemotion", detectShake, false);
      startGame();
    }
  }

  function startGame() {
    if (gameStarted) return;
    gameStarted = true;
    document.getElementById("permissionOverlay").style.display = "none";
    setTimeout(showNextWord, 5000); // 5 Sekunden „Bereit?“
  }

  document.getElementById("startButton").addEventListener("click", enableMotionDetection);
</script>
{% endblock %}

