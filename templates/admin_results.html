{% extends 'base.html' %}

{% block title %}Admin â€“ Ergebnisse Ãœbersicht{% endblock %}

{% block content %}
  <style>
    h2 {
      font-size: 2.5rem;
      margin-bottom: 1.5rem;
    }

    h3 {
      font-size: 1.8rem;
      margin-top: 1rem;
    }

    ol#topList {
      font-size: 1.3rem;
      line-height: 1.8;
    }

    li {
      margin-bottom: 0.5rem;
    }

    #barChart {
      width: 100%;
      max-width: 1000px;
      height: auto;
    }
  </style>

  <h2>Live-Auswertung</h2>
  <div style="display: flex; flex-direction: row; justify-content: space-around; flex-wrap: wrap;">
    <div>
      <canvas id="barChart" style="width: 960px; height: 540px;"></canvas>
    </div>
    <div>
      <h3>ğŸ† Toplist</h3>
      <ol id="topList"></ol>
    </div>
  </div>
{% endblock %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
let chart;

function prepareHighResCanvas(canvas, width, height) {
  const dpr = window.devicePixelRatio || 1;
  canvas.width = width * dpr;
  canvas.height = height * dpr;
  canvas.style.width = width + "px";
  canvas.style.height = height + "px";
  const ctx = canvas.getContext("2d");
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.scale(dpr, dpr);
  return ctx;
}

async function fetchDataAndUpdate() {
  const response = await fetch(window.location.href);
  const html = await response.text();
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, "text/html");
  const raw = doc.querySelector("script[data-results]")?.dataset.results;

  if (!raw) return;

  const results = JSON.parse(raw);
  const scoreCounts = {};

  results.forEach(entry => {
    const score = entry.score;
    scoreCounts[score] = (scoreCounts[score] || 0) + 1;
  });

  const sortedScores = Object.keys(scoreCounts).map(Number).sort((a, b) => a - b);
  const playerCounts = sortedScores.map(score => scoreCounts[score]);

  const canvas = document.getElementById("barChart");
  const ctx = prepareHighResCanvas(canvas, 960, 540);

  if (chart) {
    chart.data.labels = playerCounts.map(count => `${count}`); // Anzahl Spieler als X-Label
    chart.data.datasets[0].data = sortedScores; // Punkte als BalkenhÃ¶he
    chart.update();
  } else {
    chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: playerCounts.map(count => `${count}`), // Anzahl Spieler unter Balken
        datasets: [{
          label: "Punkte",
          data: sortedScores,
          backgroundColor: "#0077cc"
        }]
      },
      options: {
        responsive: false,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          datalabels: {
            anchor: 'end',
            align: 'end',
            font: {
              weight: 'bold',
              size: 16
            },
            color: "#000",
            formatter: (value) => `${value} Punkte`
          }
        },
        scales: {
          x: {
            title: {
              display: false
            },
            ticks: {
              font: {
                size: 14
              },
              callback: function(value, index) {
                return this.getLabelForValue(index);
              }
            }
          },
          y: {
            beginAtZero: true,
            suggestedMax: 20,
            title: {
              display: true,
              text: "Punkte",
              font: {
                size: 18
              }
            },
            ticks: {
              stepSize: 1,
              precision: 0,
              font: {
                size: 14
              }
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  }

  const sortedResults = results.slice().sort((a, b) => b.score - a.score);
  const ol = document.getElementById("topList");
  ol.innerHTML = "";
  sortedResults.forEach(r => {
    const li = document.createElement("li");
    li.textContent = `ğŸ† ${r.name} â€“ ${r.score} Punkte`;
    ol.appendChild(li);
  });
}

fetchDataAndUpdate();
setInterval(fetchDataAndUpdate, 5000);
</script>

<!-- Ergebnisse eingebettet -->
<script data-results='{{ results | tojson | safe }}'></script>
{% endblock %}
